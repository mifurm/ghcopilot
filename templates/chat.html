<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Trip Planner Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß≥ Family Trip Planner</h1>
            <p>Plan your perfect family vacation with our chat assistant</p>
            <div class="header-info">
                <span class="session-indicator" id="session-indicator">üíæ Browser Session Active</span>
            </div>
            <button id="clear-btn" class="clear-btn">Clear Chat</button>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">
                <p>üëã Welcome! I'm here to help you plan your family trip.</p>
                <p>Tell me about your destination, travel dates, and who's traveling!</p>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Type your message here..." 
                autocomplete="off"
            >
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');

        // Session storage key
        const SESSION_KEY = 'family_trip_planner_chat_history';

        // Load chat history on page load
        window.addEventListener('load', () => {
            loadHistory();
            updateSessionIndicator();
            checkAzureAIStatus();
        });

        // Send message on button click
        sendBtn.addEventListener('click', sendMessage);

        // Send message on Enter key
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Clear chat history
        clearBtn.addEventListener('click', clearChat);

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Create user message object
            const userMsg = {
                role: 'user',
                message: message,
                timestamp: new Date().toISOString()
            };

            // Display user message
            addMessage(message, 'user');
            userInput.value = '';

            // Save user message to session
            saveMessageToSession(userMsg);

            // Show typing indicator
            const typingIndicator = addTypingIndicator();

            try {
                // Send message to server
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                const data = await response.json();

                // Remove typing indicator
                typingIndicator.remove();

                // Display bot response
                if (data.response) {
                    const botMsg = {
                        role: 'bot',
                        message: data.response,
                        timestamp: data.timestamp || new Date().toISOString()
                    };
                    addMessage(data.response, 'bot');
                    // Save bot message to session
                    saveMessageToSession(botMsg);
                } else if (data.error) {
                    const errorMsg = {
                        role: 'bot',
                        message: 'Sorry, something went wrong. Please try again.',
                        timestamp: new Date().toISOString()
                    };
                    addMessage(errorMsg.message, 'bot');
                    saveMessageToSession(errorMsg);
                }
            } catch (error) {
                typingIndicator.remove();
                const errorMsg = {
                    role: 'bot',
                    message: 'Sorry, I encountered an error. Please try again.',
                    timestamp: new Date().toISOString()
                };
                addMessage(errorMsg.message, 'bot');
                saveMessageToSession(errorMsg);
                console.error('Error:', error);
            }
        }

        function addMessage(text, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }

        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar">ü§ñ</div>
                <div class="message-content">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return typingDiv;
        }

        async function loadHistory() {
            try {
                // Load from browser session storage (localStorage)
                const sessionData = localStorage.getItem(SESSION_KEY);
                
                if (sessionData) {
                    const history = JSON.parse(sessionData);
                    
                    if (history && history.length > 0) {
                        // Clear welcome message if history exists
                        const welcomeMsg = chatContainer.querySelector('.welcome-message');
                        if (welcomeMsg) welcomeMsg.remove();
                        
                        // Display all messages from session
                        history.forEach(msg => {
                            addMessage(msg.message, msg.role);
                        });
                        
                        console.log(`Loaded ${history.length} messages from browser session`);
                        return;
                    }
                }
                
                // Fallback: try to load from server
                const response = await fetch('/api/history');
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    // Clear welcome message if history exists
                    const welcomeMsg = chatContainer.querySelector('.welcome-message');
                    if (welcomeMsg) welcomeMsg.remove();
                    
                    // Display all messages
                    data.history.forEach(msg => {
                        addMessage(msg.message, msg.role);
                    });
                    
                    // Save server history to session
                    localStorage.setItem(SESSION_KEY, JSON.stringify(data.history));
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function clearChat() {
            if (!confirm('Are you sure you want to clear the chat history?')) {
                return;
            }

            try {
                // Clear browser session storage
                localStorage.removeItem(SESSION_KEY);
                console.log('Cleared browser session storage');

                // Also clear server-side history
                const response = await fetch('/api/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Clear the chat container
                    chatContainer.innerHTML = `
                        <div class="welcome-message">
                            <p>üëã Welcome! I'm here to help you plan your family trip.</p>
                            <p>Tell me about your destination, travel dates, and who's traveling!</p>
                        </div>
                    `;
                    
                    // Update session indicator
                    updateSessionIndicator();
                }
            } catch (error) {
                console.error('Error clearing chat:', error);
                alert('Failed to clear chat history. Please try again.');
            }
        }

        function saveMessageToSession(message) {
            try {
                // Get existing history from localStorage
                const sessionData = localStorage.getItem(SESSION_KEY);
                let history = sessionData ? JSON.parse(sessionData) : [];
                
                // Add new message
                history.push(message);
                
                // Save back to localStorage
                localStorage.setItem(SESSION_KEY, JSON.stringify(history));
                console.log('Saved message to browser session:', message.role);
                
                // Update session indicator
                updateSessionIndicator();
            } catch (error) {
                console.error('Error saving to session:', error);
            }
        }

        function getSessionHistory() {
            try {
                const sessionData = localStorage.getItem(SESSION_KEY);
                return sessionData ? JSON.parse(sessionData) : [];
            } catch (error) {
                console.error('Error getting session history:', error);
                return [];
            }
        }

        function updateSessionIndicator() {
            const indicator = document.getElementById('session-indicator');
            const history = getSessionHistory();
            const messageCount = history.length;
            
            if (messageCount > 0) {
                indicator.textContent = `üíæ Browser Session Active (${messageCount} messages)`;
                indicator.style.display = 'inline-block';
            } else {
                indicator.textContent = 'üíæ Browser Session Active';
                indicator.style.display = 'inline-block';
            }
        }

        async function checkAzureAIStatus() {
            try {
                const response = await fetch('/api/ai-status');
                const status = await response.json();
                
                const indicator = document.getElementById('session-indicator');
                
                if (status.configured) {
                    // Add Azure AI badge
                    const aiBadge = document.createElement('span');
                    aiBadge.className = 'session-indicator';
                    aiBadge.textContent = `ü§ñ Azure AI: ${status.model_name}`;
                    aiBadge.style.marginLeft = '10px';
                    aiBadge.style.background = 'rgba(72, 187, 120, 0.2)';
                    aiBadge.style.borderColor = 'rgba(72, 187, 120, 0.3)';
                    indicator.parentElement.appendChild(aiBadge);
                } else {
                    // Show warning if not configured
                    const warningBadge = document.createElement('span');
                    warningBadge.className = 'session-indicator';
                    warningBadge.textContent = '‚ö†Ô∏è Azure AI not configured';
                    warningBadge.style.marginLeft = '10px';
                    warningBadge.style.background = 'rgba(255, 193, 7, 0.2)';
                    warningBadge.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                    indicator.parentElement.appendChild(warningBadge);
                }
            } catch (error) {
                console.error('Error checking Azure AI status:', error);
            }
        }
    </script>
</body>
</html>
